<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react-dom.js"></script>
        <script src="jeri.min.js"></script>
    </head>

    <body>
        <div id="my-viewer" style="width: 100%; height: 600px;"></div>
        <script>
            async function get_experiment_data(exp) {
                const response = await fetch(exp);
                const json = await response.json();
                return json
            }

            (async () => {
                let experiments = [
                    "surface-type-plane"
                ]

                let data = {
                    title: "root",
                    children: []
                }

                const cartesian = (...a) => a.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));

                function set_child_data(obj, idx, id_set, values, param_names, basepath) {
                    id = id_set[idx];
                    if(idx < id_set.length-1) {
                        if(obj.children.length <= id) {
                            obj.children.push({
                                title: param_names[idx] + "=" + values[idx],
                                children: []
                            });
                        }
                        set_child_data(obj.children[id], idx+1, id_set, values, param_names, basepath);
                    } else {
                        obj.children.push({
                            title: param_names[idx] + "=" + values[idx],
                            image: basepath + id_set.join("-") + ".exr",
                        });
                    }
                }

                for (let exp in experiments) {
                    const exp_data = await get_experiment_data('./experiments/' + experiments[exp] + '/' + experiments[exp] + '.json');
                    console.log(exp_data)
                    let exp_viewer_data = {
                        title: exp_data["name"],
                        children: []
                    };
                    
                    let param_values = [];
                    let param_ids = [];
                    let param_names = [];

                    for (let param in exp_data.params){
                        param_names.push(param)
                        console.log(param);
                        param_values.push(exp_data.params[param])
                        param_ids.push([...Array(exp_data.params[param].length).keys()])
                    }


                    param_value_combos = cartesian(...param_values)
                    param_id_combos = cartesian(...param_ids)


                    for(let param_combo in param_value_combos) {
                        set_child_data(exp_viewer_data, 0, param_id_combos[param_combo], param_value_combos[param_combo], param_names,
                            './experiments/' + experiments[exp] + '/images/');
                    }

                    data.children.push(exp_viewer_data)
                }

                // Call renderViewer as often as you want, any time the data changes
                // Updates are cheap, efficient, and state is preserved
                Jeri.renderViewer(document.getElementById('my-viewer'), data);
            })()
        </script>
    </body>
</html>
