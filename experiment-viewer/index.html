<html>
    <head>
        <title>Stochastic Implicit Surfaces - Compare</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.6.1/react-dom.js"></script>
        <script src="jeri.min.js"></script>
    </head>
    <body style="margin: 0; padding:0;">
        <div style="width: 100%; height: 100%; position:relative; margin: 0; padding: 0;">
            <div id="my-viewer" style="width: 100%; height: 100%;position:relative;"></div>
            <div style="position:absolute; bottom: 10px; left:10px">
                <button onclick="saveImage()">Save current image</button>
                <button onclick="addToComparison()">Add to comparison</button>
                <button onclick="clearComparison()">Clear comparison</button>
                <button onclick="openComparison()">Open comparison in new window</button>
                <div id="comp-list-container" style="display: none; background-color: white; outline-color: black;">Comparisons: <label  id="comp-list"></label></div>
            </div>
        </div>

        <script>

            let viewer = {}

            let data = {
                 title: "root",
                 children: []
            };

            let comp_data = {
                title: "root",
                children: []
            }

            function find_image_url(data, selection) {
                for (let node in data) {
                    if(data[node].title == selection[0]) {
                        if(selection.length == 1) {
                            return data[node].image;
                        } else {
                            return find_image_url(data[node].children, selection.slice(1))
                        }
                    }
                }
            }

            function saveImage()
            {
                window.location.href = find_image_url(data.children, viewer.state.selection)
            }

            function addToComparison()
            {
                url = find_image_url(data.children, viewer.state.selection)
                label = window.prompt("Enter label", viewer.state.selection)

                comp_data.children.push({
                    title: label,
                    image: url
                })

                //Jeri.renderViewer(document.getElementById('comp-viewer'), comp_data);
                //document.getElementById('comp-viewer').style.display = "block";
                document.getElementById('comp-list-container').style.display = "block";
                document.getElementById('comp-list').innerHTML = comp_data.children.map((c) => c.title)
            }

            function clearComparison()
            {
                comp_data.children = []
                //document.getElementById('comp-viewer').style.display = "none";
                document.getElementById('comp-list-container').style.display = "none";
                document.getElementById('comp-list').innerHTML = comp_data.children.map((c) => c.title)
            }

            function openComparison()
            {
                note = window.prompt("Enter a note", document.getElementById('note').innerHTML)

                if(note) {
                window.location.href = "./compare.html?" + 
                    "comp=" + encodeURIComponent(comp_data.children.map((c) => c.image)) + 
                    "&labels=" + encodeURIComponent(comp_data.children.map((c) => c.title)) +
                    "&exp=" + viewer.state.exposure.default +
                    "&note=" + encodeURIComponent(note)
                }
            }

            async function get_experiment_data(exp) {
                const response = await fetch(exp);
                const json = await response.json();
                return json
            }

            (async () => {
                let experiments = [
                    "surface-type-plane-fixed", "surface-dori-goldfish", "surface-isotropy-effect", "volume-type-wedge-mirror", "volume-type-wedge-diffuse", "volume-type-wedge-diffuse-rq"
                ]

                data = {
                    title: "root",
                    children: []
                }

                const cartesian = (...a) => a.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));

                function set_child_data(obj, idx, id_set, values, param_names, basepath) {
                    id = id_set[idx];

                    if (idx < id_set.length - 1) {
                        if (obj.children.length <= id) {
                            obj.children.push({
                                title: param_names[idx] + "=" + values[idx],
                                children: []
                            });
                        }

                        set_child_data(obj.children[id], idx + 1, id_set, values, param_names, basepath);
                    } else {
                        obj.children.push({
                            title: param_names[idx] + "=" + values[idx],
                            image: basepath + id_set.join("-") + ".exr",
                        });
                    }
                }

                for (let exp in experiments) {

                    const exp_data = await get_experiment_data('./experiments/' + experiments[exp] + '/' + experiments[exp] + '.json');

                    let exp_viewer_data = {
                        title: exp_data["name"],
                        children: []
                    };

                    let param_values = [];
                    let param_ids = [];
                    let param_names = [];

                    for (let param in exp_data.params) {
                        param_names.push(param)
                        param_values.push(exp_data.params[param])
                        param_ids.push([...Array(exp_data.params[param].length).keys()])
                    }

                    console.log(param_names)

                    param_value_combos = cartesian(...param_values)
                    param_id_combos = cartesian(...param_ids)

                    for (let param_combo in param_value_combos) {
                        set_child_data(exp_viewer_data, 0, param_id_combos[param_combo], param_value_combos[param_combo], param_names,
                            './experiments/' + experiments[exp] + '/images/');
                    }

                    data.children.push(exp_viewer_data)
                }
                
                
                // Call renderViewer as often as you want, any time the data changes
                // Updates are cheap, efficient, and state is preserved
                viewer = Jeri.renderViewer(document.getElementById('my-viewer'), data);
                console.log(viewer)

            })()
        </script>
    </body>
</html>